---
import Hr from "./Hr.astro";
import IconX from "@/assets/icons/IconX.svg";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconMenuDeep from "@/assets/icons/IconMenuDeep.svg";
import IconMonitor from "@/assets/icons/IconMonitor.svg";
import IconCheck from "@/assets/icons/IconCheck.svg";
import { SITE } from "@/config";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<header>
  <a
    id="skip-to-content"
    href="#main-content"
    class="absolute start-16 -top-full z-50 bg-background px-3 py-2 text-accent backdrop-blur-lg transition-all focus:top-4"
  >
    Skip to content
  </a>
  <div
    id="nav-container"
    class="mx-auto flex max-w-app flex-col items-center justify-between sm:flex-row"
  >
    <div
      id="top-nav-wrap"
      class="relative flex w-full items-baseline justify-between p-4 sm:items-center sm:py-6"
    >
      <a
        href="/"
        class="site-title absolute py-1 text-xl leading-8 font-semibold whitespace-nowrap sm:static sm:my-auto sm:text-2xl sm:leading-none"
      >
        {SITE.title}
      </a>
      <nav
        id="nav-menu"
        class="flex w-full flex-col items-center sm:ms-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0"
      >
        <button
          id="menu-btn"
          class="focus-outline self-end p-2 sm:hidden"
          aria-label="Open Menu"
          aria-expanded="false"
          aria-controls="menu-items"
        >
          <IconX id="close-icon" class="hidden" />
          <IconMenuDeep id="menu-icon" />
        </button>
        <ul
          id="menu-items"
          class:list={[
            "mt-4 grid w-44 grid-cols-2 place-content-center gap-2",
            "[&>li>a]:block [&>li>a]:px-4 [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent sm:[&>li>a]:px-2 sm:[&>li>a]:py-1",
            "hidden",
            "sm:mt-0 sm:flex sm:w-auto sm:gap-x-5 sm:gap-y-0",
          ]}
        >
          <li class="col-span-2">
            <a href="/posts" class:list={{ "active-nav": isActive("/posts") }}>
              Posts
            </a>
          </li>
          <li class="col-span-2">
            <a href="/tags" class:list={{ "active-nav": isActive("/tags") }}>
              Tags
            </a>
          </li>
          <li class="col-span-2">
            <a href="/about" class:list={{ "active-nav": isActive("/about") }}>
              About
            </a>
          </li>
          {
            SITE.showArchives && (
              <li class="col-span-2">
                <a
                  href="/archives"
                  class:list={{ "active-nav": isActive("/archives") }}
                >
                  Archives
                </a>
              </li>
            )
          }
          <li class="col-span-1 flex items-center justify-center">
            <button
              id="search-btn"
              class="focus-outline flex p-3 sm:p-1"
              aria-label="Open search"
              title="Search"
            >
              <IconSearch />
              <span class="sr-only">Search</span>
            </button>
          </li>
          {
            SITE.lightAndDarkMode && (
              <li class="relative col-span-1 flex items-center justify-center">
                <button
                  id="theme-btn"
                  class="focus-outline relative size-12 rounded-lg border border-border p-4 sm:size-8 hover:[&>svg]:stroke-accent"
                  title="Select theme"
                  aria-label="Select theme"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <IconMonitor
                    id="theme-icon-system"
                    class="absolute top-1/2 left-1/2"
                  />
                  <IconSunHigh
                    id="theme-icon-light"
                    class="absolute top-1/2 left-1/2"
                  />
                  <IconMoon
                    id="theme-icon-dark"
                    class="absolute top-1/2 left-1/2"
                  />
                </button>
                <div
                  id="theme-dropdown"
                  class="absolute top-full right-0 z-50 mt-2 hidden w-32 rounded-lg border-2 border-border bg-background shadow-lg"
                >
                  <div class="py-1">
                    <button
                      data-theme="system"
                      class="flex w-full items-center px-3 py-2 text-sm transition-colors hover:bg-muted/30"
                    >
                      <IconMonitor class="h-5 w-5" />
                      <span class="ml-2">System</span>
                      <IconCheck
                        class="ml-auto h-4 w-4 text-accent opacity-0"
                        data-check="system"
                      />
                    </button>
                    <button
                      data-theme="light"
                      class="flex w-full items-center px-3 py-2 text-sm transition-colors hover:bg-muted/30"
                    >
                      <IconSunHigh class="h-5 w-5" />
                      <span class="ml-2">Light</span>
                      <IconCheck
                        class="ml-auto h-4 w-4 text-accent opacity-0"
                        data-check="light"
                      />
                    </button>
                    <button
                      data-theme="dark"
                      class="flex w-full items-center px-3 py-2 text-sm transition-colors hover:bg-muted/30"
                    >
                      <IconMoon class="h-5 w-5" />
                      <span class="ml-2">Dark</span>
                      <IconCheck
                        class="ml-auto h-4 w-4 text-accent opacity-0"
                        data-check="dark"
                      />
                    </button>
                  </div>
                </div>
              </li>
            )
          }
        </ul>
      </nav>
    </div>
  </div>
</header>
<Hr />

<!-- Search Dialog -->
<div
  id="search-dialog"
  class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm"
  aria-modal="true"
  role="dialog"
>
  <div
    class="fixed top-8 left-1/2 max-h-[90%] min-h-[15rem] w-full max-w-2xl -translate-x-1/2 overflow-y-auto rounded-lg border border-border bg-background p-5 md:top-16 md:max-h-[80%]"
  >
    <div id="search-dialog-content"></div>
  </div>
</div>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector("#menu-btn");
    const menuItems = document.querySelector("#menu-items");
    const menuIcon = document.querySelector("#menu-icon");
    const closeIcon = document.querySelector("#close-icon");

    if (!menuBtn || !menuItems || !menuIcon || !closeIcon) return;

    menuBtn.addEventListener("click", () => {
      const openMenu = menuBtn.getAttribute("aria-expanded") === "true";

      menuBtn.setAttribute("aria-expanded", openMenu ? "false" : "true");
      menuBtn.setAttribute("aria-label", openMenu ? "Open Menu" : "Close Menu");

      menuItems.classList.toggle("hidden");
      menuIcon.classList.toggle("hidden");
      closeIcon.classList.toggle("hidden");
    });
  }

  toggleNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", toggleNav);

  // Theme dropdown
  let themeDropdownCleanup: (() => void) | null = null;

  function initThemeDropdown() {
    // Clean up previous event listeners
    if (themeDropdownCleanup) {
      themeDropdownCleanup();
    }

    const themeBtn = document.querySelector("#theme-btn");
    const themeDropdown = document.querySelector("#theme-dropdown");
    const themeOptions = document.querySelectorAll("[data-theme]");

    if (!themeBtn || !themeDropdown) return;

    // Update check marks based on current theme
    function updateCheckMarks() {
      const currentTheme = localStorage.getItem("theme") || "system";
      document.querySelectorAll("[data-check]").forEach(check => {
        const checkTheme = check.getAttribute("data-check");
        if (checkTheme === currentTheme) {
          check.classList.remove("opacity-0");
        } else {
          check.classList.add("opacity-0");
        }
      });
    }

    updateCheckMarks();

    // Toggle dropdown
    const handleToggle = (e: Event) => {
      e.stopPropagation();
      const isExpanded = themeBtn.getAttribute("aria-expanded") === "true";
      themeBtn.setAttribute("aria-expanded", isExpanded ? "false" : "true");
      themeDropdown.classList.toggle("hidden");
    };

    themeBtn.addEventListener("click", handleToggle);

    // Handle theme selection
    const optionHandlers: Array<{
      element: Element;
      handler: (e: Event) => void;
    }> = [];

    themeOptions.forEach(option => {
      const handler = (e: Event) => {
        e.stopPropagation();
        const theme = option.getAttribute("data-theme");
        if (theme) {
          const currentTheme = localStorage.getItem("theme") || "system";

          // Only update if theme changed
          if (theme !== currentTheme) {
            localStorage.setItem("theme", theme);

            // Call the global reflectPreference function from toggle-theme.js
            // @ts-expect-error - Custom properties added by toggle-theme.js
            if (typeof window.reflectPreference === "function") {
              // Update themeMode global variable
              // @ts-expect-error - Custom properties added by toggle-theme.js
              window.themeMode = theme;
              // Recalculate themeValue
              // @ts-expect-error - Custom properties added by toggle-theme.js
              window.themeValue =
                theme === "system"
                  ? window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "dark"
                    : "light"
                  : theme;
              // @ts-expect-error - Custom properties added by toggle-theme.js
              window.reflectPreference();
            } else {
              // Fallback if toggle-theme.js is not loaded
              const prefersDark = window.matchMedia(
                "(prefers-color-scheme: dark)"
              ).matches;
              const resolvedTheme =
                theme === "system" ? (prefersDark ? "dark" : "light") : theme;

              document.documentElement.setAttribute("data-theme", theme);
              document.documentElement.setAttribute(
                "data-theme-resolved",
                resolvedTheme
              );
            }

            updateCheckMarks();
          }

          // Always close dropdown after clicking
          themeDropdown.classList.add("hidden");
          themeBtn.setAttribute("aria-expanded", "false");
        }
      };

      option.addEventListener("click", handler);
      optionHandlers.push({ element: option, handler });
    });

    // Close dropdown when clicking outside
    const closeDropdown = (e: Event) => {
      const target = e.target as Node;
      if (
        !themeDropdown.classList.contains("hidden") &&
        !themeDropdown.contains(target) &&
        !themeBtn.contains(target)
      ) {
        themeDropdown.classList.add("hidden");
        themeBtn.setAttribute("aria-expanded", "false");
      }
    };

    document.addEventListener("click", closeDropdown);

    // Store cleanup function
    themeDropdownCleanup = () => {
      themeBtn.removeEventListener("click", handleToggle);
      optionHandlers.forEach(({ element, handler }) => {
        element.removeEventListener("click", handler);
      });
      document.removeEventListener("click", closeDropdown);
    };
  }

  initThemeDropdown();
  document.addEventListener("astro:after-swap", initThemeDropdown);

  // Search dialog
  function initSearchDialog() {
    const searchBtn = document.querySelector("#search-btn");
    const searchDialog = document.querySelector("#search-dialog");
    const searchDialogContent = document.querySelector(
      "#search-dialog-content"
    );

    if (!searchBtn || !searchDialog || !searchDialogContent) return;

    // eslint-disable-next-line @typescript-eslint/no-explicit-any -- PagefindUI has no official types
    let pagefindUI: any = null;

    // Open search dialog
    async function openSearchDialog() {
      if (!searchDialog || !searchDialogContent) return;

      searchDialog.classList.remove("hidden");
      document.body.style.overflow = "hidden";

      // Initialize pagefind if not already done
      if (!pagefindUI) {
        try {
          // @ts-expect-error - Missing types for @pagefind/default-ui
          const { PagefindUI } = await import("@pagefind/default-ui");

          pagefindUI = new PagefindUI({
            element: "#search-dialog-content",
            showSubResults: true,
            showImages: false,
          });

          // Wait for PagefindUI to render
          setTimeout(() => {
            const input = document.querySelector<HTMLElement>(
              ".pagefind-ui__search-input"
            );
            if (input) {
              input.focus();
            }
          }, 150);
        } catch (error) {
          // eslint-disable-next-line no-console -- Log error for debugging since search is a critical feature
          console.error("Failed to load Pagefind:", error);
          if (searchDialogContent) {
            searchDialogContent.innerHTML =
              '<p class="text-muted p-4">Failed to load search. Please try again.</p>';
          }
        }
      } else {
        // If already initialized, just focus the input
        setTimeout(() => {
          const input = document.querySelector<HTMLElement>(
            ".pagefind-ui__search-input"
          );
          if (input) {
            input.focus();
          }
        }, 50);
      }
    }

    // Close search dialog
    function closeSearchDialog() {
      if (!searchDialog) return;
      searchDialog.classList.add("hidden");
      document.body.style.overflow = "";
    }

    // Open on search button click
    searchBtn.addEventListener("click", openSearchDialog);

    // Close on backdrop click
    searchDialog.addEventListener("click", e => {
      if (e.target === searchDialog) {
        closeSearchDialog();
      }
    });

    // Close on Escape key
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && !searchDialog.classList.contains("hidden")) {
        closeSearchDialog();
      }
    });

    // Open on Cmd+K or Ctrl+K
    document.addEventListener("keydown", e => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        openSearchDialog();
      }
    });

    // Close dialog when clicking on a search result link
    searchDialogContent.addEventListener("click", e => {
      if ((e.target as HTMLElement).tagName === "A") {
        closeSearchDialog();
      }
    });
  }

  initSearchDialog();
  document.addEventListener("astro:after-swap", initSearchDialog);
</script>
